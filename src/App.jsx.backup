import { useEffect, useMemo, useState } from "react";
import { Upload, Video, Image as ImageIcon, Play, Download, Clock, CheckCircle, XCircle, Loader } from "lucide-react";

const API_BASE = import.meta.env.VITE_API_URL || "http://127.0.0.1:8000/api";

const POSITIONS = [
  { value: "top-left", label: "Top Left", icon: "↖" },
  { value: "top-right", label: "Top Right", icon: "↗" },
  { value: "bottom-left", label: "Bottom Left", icon: "↙" },
  { value: "bottom-right", label: "Bottom Right", icon: "↘" },
  { value: "full", label: "Full Screen", icon: "⛶" },
];

export default function App() {
  const [files, setFiles] = useState([]);
  const [logo, setLogo] = useState(null);
  const [jobs, setJobs] = useState([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState("");
  const [position, setPosition] = useState("bottom-right");
  const [scale, setScale] = useState(0.2);
  
  // Preview states
  const [previewVideoUrl, setPreviewVideoUrl] = useState(null);
  const [previewLogoUrl, setPreviewLogoUrl] = useState(null);

  const canSubmit = useMemo(() => files.length > 0 && logo, [files, logo]);

  const fetchJobs = async () => {
    try {
      const response = await fetch(`${API_BASE}/jobs`);
      if (!response.ok) {
        throw new Error("Failed to load jobs");
      }
      const data = await response.json();
      setJobs(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to load jobs");
    }
  };

  useEffect(() => {
    const timer = setTimeout(fetchJobs, 500);
    const interval = setInterval(fetchJobs, 5000);
    return () => {
      clearTimeout(timer);
      clearInterval(interval);
    };
  }, []);

  useEffect(() => {
    // Create preview URL for first video
    if (files.length > 0) {
      const url = URL.createObjectURL(files[0]);
      setPreviewVideoUrl(url);
      return () => URL.revokeObjectURL(url);
    } else {
      setPreviewVideoUrl(null);
    }
  }, [files]);

  useEffect(() => {
    // Create preview URL for logo
    if (logo) {
      const url = URL.createObjectURL(logo);
      setPreviewLogoUrl(url);
      return () => URL.revokeObjectURL(url);
    } else {
      setPreviewLogoUrl(null);
    }
  }, [logo]);

  const handleSubmit = async () => {
    if (!canSubmit) return;
    setError("");
    setIsSubmitting(true);
    try {
      const formData = new FormData();
      files.forEach((file) => formData.append("videos", file));
      formData.append("logo", logo);
      formData.append("position", position);
      formData.append("scale", scale.toString());

      const response = await fetch(`${API_BASE}/jobs/upload`, {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        throw new Error("Upload failed");
      }

      await fetchJobs();
      setFiles([]);
      setLogo(null);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Upload failed");
    } finally {
      setIsSubmitting(false);
    }
  };

  const queuedCount = jobs.filter((job) => job.status === "queued").length;
  const processingCount = jobs.filter((job) => job.status === "processing").length;
  const completedCount = jobs.filter((job) => job.status === "completed").length;

  // Calculate logo position and size for preview
  const getLogoStyle = () => {
    const styles = { position: "absolute", maxWidth: "100%", maxHeight: "100%" };
    
    if (position === "full") {
      return { ...styles, top: 0, left: 0, width: "100%", height: "100%", objectFit: "cover" };
    }
    
    const size = `${scale * 100}%`;
    const padding = "20px";
    
    switch (position) {
      case "top-left":
        return { ...styles, top: padding, left: padding, height: size };
      case "top-right":
        return { ...styles, top: padding, right: padding, height: size };
      case "bottom-left":
        return { ...styles, bottom: padding, left: padding, height: size };
      case "bottom-right":
      default:
        return { ...styles, bottom: padding, right: padding, height: size };
    }
  };

  return (
    <div className="min-h-screen bg-slate-950 text-white">
      <header className="mx-auto max-w-6xl px-6 py-10">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm uppercase tracking-widest text-cyan-300">Automark</p>
            <h1 className="text-4xl font-bold sm:text-5xl">Bulk Video Watermarking</h1>
            <p className="mt-3 max-w-xl text-slate-300">
              Upload videos and a logo, then let Automark process them in the background.
            </p>
          </div>
          <button className="rounded-full bg-cyan-500 px-5 py-2 text-sm font-semibold text-slate-900 shadow-lg shadow-cyan-500/30">
            Upgrade
          </button>
        </div>
        {error && (
          <div className="mt-6 rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200">
            {error}
          </div>
        )}
      </header>

      <main className="mx-auto max-w-6xl px-6 pb-16">
        <section className="grid gap-6 lg:grid-cols-3">
          <div className="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-xl">
            <h2 className="text-lg font-semibold">1. Add Videos</h2>
            <p className="mt-2 text-sm text-slate-300">
              Upload multiple files. We’ll queue them for processing.
            </p>
            <input
              type="file"
              multiple
              className="mt-4 w-full cursor-pointer rounded-lg border border-dashed border-slate-700 bg-slate-950 p-4 text-sm text-slate-300"
              onChange={(e) => setFiles(Array.from(e.target.files || []))}
            />
            <p className="mt-3 text-xs text-slate-500">
              {files.length ? `${files.length} files selected` : "No files selected"}
            </p>
          </div>

          <div className="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-xl">
            <h2 className="text-lg font-semibold">2. Upload Logo</h2>
            <p className="mt-2 text-sm text-slate-300">
              Transparent PNG recommended for best quality.
            </p>
            <input
              type="file"
              className="mt-4 w-full cursor-pointer rounded-lg border border-dashed border-slate-700 bg-slate-950 p-4 text-sm text-slate-300"
              onChange={(e) => setLogo(e.target.files?.[0] || null)}
            />
            <p className="mt-3 text-xs text-slate-500">
              {logo ? logo.name : "No logo selected"}
            </p>
          </div>

          <div className="rounded-2xl border border-slate-800 bg-gradient-to-br from-cyan-500/15 to-indigo-500/10 p-6 shadow-xl">
            <h2 className="text-lg font-semibold">3. Launch Job</h2>
            <p className="mt-2 text-sm text-slate-300">
              Automark will watermark everything in the queue.
            </p>
            <button
              className="mt-6 w-full rounded-xl bg-cyan-500 px-4 py-3 text-sm font-semibold text-slate-900 shadow-lg shadow-cyan-500/30 disabled:cursor-not-allowed disabled:bg-slate-700 disabled:text-slate-300"
              onClick={handleSubmit}
              disabled={!canSubmit || isSubmitting}
            >
              {isSubmitting ? "Uploading..." : "Start Processing"}
            </button>
            <div className="mt-6 rounded-xl border border-slate-800 bg-slate-950 p-4">
              <p className="text-xs uppercase tracking-wide text-slate-500">Queue Status</p>
              <div className="mt-3 space-y-2 text-sm text-slate-300">
                <div className="flex items-center justify-between">
                  <span>Queued</span>
                  <span className="font-semibold">{queuedCount}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span>Processing</span>
                  <span className="font-semibold">{processingCount}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span>Completed</span>
                  <span className="font-semibold">{completedCount}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span>Logo</span>
                  <span className="font-semibold">{logo ? "Ready" : "Missing"}</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section className="mt-10 grid gap-6 lg:grid-cols-2">
          <div className="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
            <h3 className="text-lg font-semibold">Recent Jobs</h3>
            <p className="mt-2 text-sm text-slate-300">Live status from the API.</p>
            <div className="mt-4 space-y-3">
              {jobs.length === 0 && (
                <div className="rounded-xl border border-slate-800 bg-slate-950 p-4 text-sm text-slate-400">
                  No jobs yet.
                </div>
              )}
              {jobs.map((job) => (
                <div key={job.id} className="rounded-xl border border-slate-800 bg-slate-950 p-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium truncate">{job.input_name}</span>
                    <span className={`rounded-full px-3 py-1 text-xs font-semibold ${
                      job.status === "processing" ? "bg-blue-500/20 text-blue-300 animate-pulse" :
                      job.status === "completed" ? "bg-green-500/20 text-green-300" :
                      job.status === "failed" ? "bg-red-500/20 text-red-300" :
                      "bg-cyan-500/10 text-cyan-300"
                    }`}>
                      {job.status}
                    </span>
                  </div>
                  <p className="mt-2 text-xs text-slate-500">Logo: {job.logo_name}</p>
                  
                  {job.status === "processing" && (
                    <div className="mt-3">
                      <div className="h-2 w-full rounded-full bg-slate-700 overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-blue-500 to-cyan-500 animate-pulse" style={{ width: "60%" }}></div>
                      </div>
                      <p className="mt-2 text-xs text-blue-300">Processing in progress...</p>
                    </div>
                  )}
                  
                  {job.status === "completed" && job.output_name && (
                    <div className="mt-3">
                      <div className="h-2 w-full rounded-full bg-slate-700 overflow-hidden">
                        <div className="h-full w-full bg-gradient-to-r from-green-500 to-emerald-500"></div>
                      </div>
                      <a
                        className="mt-3 inline-flex items-center gap-2 rounded-lg bg-green-500/20 px-4 py-2 text-xs font-semibold text-green-300 border border-green-500/30 hover:bg-green-500/30 transition"
                        href={`${API_BASE}/jobs/${job.id}/download`}
                        download
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Download output
                      </a>
                    </div>
                  )}
                  
                  {job.status === "failed" && (
                    <div className="mt-3">
                      <div className="h-2 w-full rounded-full bg-slate-700 overflow-hidden">
                        <div className="h-full w-full bg-red-500"></div>
                      </div>
                      <p className="mt-2 text-xs text-red-300">Processing failed. Please try again.</p>
                    </div>
                  )}
                  
                  {job.status === "queued" && (
                    <div className="mt-3">
                      <div className="h-2 w-full rounded-full bg-slate-700 overflow-hidden">
                        <div className="h-full bg-cyan-500/40" style={{ width: "10%" }}></div>
                      </div>
                      <p className="mt-2 text-xs text-slate-400">Waiting to process...</p>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>

          <div className="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
            <h3 className="text-lg font-semibold">Usage</h3>
            <p className="mt-2 text-sm text-slate-300">
              Track monthly usage and billing in one place.
            </p>
            <div className="mt-6">
              <div className="flex items-center justify-between text-sm">
                <span>Minutes processed</span>
                <span className="font-semibold">0 / 10,000</span>
              </div>
              <div className="mt-3 h-2 w-full rounded-full bg-slate-800">
                <div className="h-2 w-1/12 rounded-full bg-cyan-500"></div>
              </div>
              <button className="mt-6 w-full rounded-xl border border-cyan-500/40 bg-slate-950 px-4 py-3 text-sm font-semibold text-cyan-300">
                View Billing
              </button>
            </div>
          </div>
        </section>
      </main>
    </div>
  );
}
